# Certbot installation for AWS Elastic Beanstalk
# Works with both Amazon Linux 2 (yum) and Amazon Linux 2023 (dnf)
# Runs during container_commands phase (before app starts)

container_commands:
  # Detect OS and install certbot accordingly
  00_install_certbot:
    command: |
      #!/bin/bash
      set -e
      
      # Check if certbot is already installed
      if command -v certbot &> /dev/null; then
        echo "Certbot is already installed."
        exit 0
      fi
      
      # Detect OS version
      if [ -f /etc/os-release ]; then
        . /etc/os-release
        if [[ "$ID" == "amzn" ]]; then
          # Amazon Linux 2023 uses dnf
          if command -v dnf &> /dev/null; then
            echo "Installing certbot for Amazon Linux 2023..."
            sudo dnf install -y python3 augeas-libs || true
            sudo python3 -m venv /opt/certbot || true
            sudo /opt/certbot/bin/pip install --upgrade pip || true
            sudo /opt/certbot/bin/pip install certbot certbot-nginx || true
            sudo ln -sf /opt/certbot/bin/certbot /usr/bin/certbot || true
            echo "Certbot installation completed (AL2023)."
            exit 0
          fi
        fi
      fi
      
      # Fallback to Amazon Linux 2 (yum)
      if command -v yum &> /dev/null; then
        echo "Installing certbot for Amazon Linux 2..."
        sudo yum install -y certbot python3-certbot-nginx || true
        echo "Certbot installation completed (AL2)."
        exit 0
      fi
      
      echo "Warning: Could not determine package manager. Certbot installation skipped."
      exit 0
    ignoreErrors: true

