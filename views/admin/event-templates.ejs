<%- include('../partials/head', { title: 'Ella Rises' }) %>
<%- include('../partials/navbar', { currentPath: '/admin/event-templates' }) %>
<div class="min-h-screen bg-background pt-28 pb-20">
  <div class="container mx-auto px-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl md:text-6xl font-serif text-foreground">Event Templates</h1>
      <button onclick="openAddTemplateModal()" class="bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-4 py-2 font-medium flex items-center gap-2">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        Add Template
      </button>
    </div>
    <p class="text-foreground/60 mb-4">Event templates define reusable event types. Each event must be based on a template.</p>
    <div id="templates-container" class="bg-card border border-border rounded-xl overflow-hidden">
      <p class="text-foreground/60 p-6">Loading templates...</p>
    </div>
  </div>
</div>

<!-- Add/Edit Template Modal -->
<div id="add-template-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="bg-card rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-serif" id="template-modal-title">Add New Template</h3>
      <button onclick="closeAddTemplateModal()" class="text-foreground/60 hover:text-foreground">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <form id="add-template-form" class="space-y-4">
      <input type="hidden" name="OriginalEventName" id="original-event-name">
      <div>
        <label class="block text-sm font-medium mb-1">Template Name *</label>
        <input type="text" name="EventName" id="t-name" required class="w-full border border-border rounded-lg px-3 py-2 bg-background">
        <p class="text-xs text-foreground/50 mt-1">This will be the event name when creating events</p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Event Type</label>
        <select name="EventType" id="t-type" class="w-full border border-border rounded-lg px-3 py-2 bg-background">
          <option value="">-- Select Type --</option>
          <option value="Workshop">Workshop</option>
          <option value="Performance">Performance</option>
          <option value="Class">Class</option>
          <option value="Camp">Camp</option>
          <option value="Meeting">Meeting</option>
          <option value="Fundraiser">Fundraiser</option>
          <option value="Community Event">Community Event</option>
          <option value="Field Trip">Field Trip</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description</label>
        <textarea name="EventDescription" id="t-description" rows="3" class="w-full border border-border rounded-lg px-3 py-2 bg-background" placeholder="Describe what this event type is about..."></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Recurrence Pattern</label>
          <select name="EventRecurrencePattern" id="t-recurrence" class="w-full border border-border rounded-lg px-3 py-2 bg-background">
            <option value="">-- Select --</option>
            <option value="One-time">One-time</option>
            <option value="Weekly">Weekly</option>
            <option value="Bi-weekly">Bi-weekly</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Annually">Annually</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Default Capacity</label>
          <input type="number" name="EventDefaultCapacity" id="t-capacity" min="1" class="w-full border border-border rounded-lg px-3 py-2 bg-background">
        </div>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="button" onclick="closeAddTemplateModal()" class="flex-1 border border-border rounded-lg px-4 py-2 font-medium hover:bg-muted transition-colors">Cancel</button>
        <button type="submit" id="template-submit-btn" class="flex-1 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-4 py-2 font-medium transition-colors">Add Template</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="bg-card rounded-xl p-6 w-full max-w-md mx-4">
    <h3 class="text-xl font-serif mb-4">Confirm Delete</h3>
    <p class="text-foreground/70 mb-6" id="delete-message">Are you sure you want to delete this template?</p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 border border-border rounded-lg px-4 py-2 font-medium hover:bg-muted transition-colors">Cancel</button>
      <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-medium transition-colors">Delete</button>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
<script>
  let templatesData = [];
  let editingTemplateName = null;
  let deleteTemplateName = null;

  // Load templates
  fetch('/api/event-templates')
    .then(r => r.json())
    .then(templates => {
      templatesData = templates;
      renderTemplates(templates);
    });

  function renderTemplates(templates) {
    const container = document.getElementById('templates-container');
    if (templates.length === 0) {
      container.innerHTML = '<p class="text-foreground/60 p-6">No templates found. Create one to get started!</p>';
      return;
    }
    container.innerHTML = `
      <table class="w-full">
        <thead class="bg-muted">
          <tr>
            <th class="text-left p-4 font-medium">Template Name</th>
            <th class="text-left p-4 font-medium">Type</th>
            <th class="text-left p-4 font-medium">Recurrence</th>
            <th class="text-left p-4 font-medium">Default Capacity</th>
            <th class="text-right p-4 font-medium">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${templates.map(t => `
            <tr class="border-t border-border hover:bg-muted/50">
              <td class="p-4">
                <div class="font-medium">${t.EventName}</div>
                ${t.EventDescription ? `<div class="text-sm text-foreground/50 truncate max-w-xs">${t.EventDescription}</div>` : ''}
              </td>
              <td class="p-4">
                <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  ${t.EventType || 'Not set'}
                </span>
              </td>
              <td class="p-4 text-foreground/70">${t.EventRecurrencePattern || '-'}</td>
              <td class="p-4 text-foreground/70">${t.EventDefaultCapacity || 'Unlimited'}</td>
              <td class="p-4 text-right">
                <button onclick='openEditTemplateModal(${JSON.stringify(t).replace(/'/g, "\\'")})' class="text-blue-600 hover:text-blue-800 mr-3" title="Edit">
                  <svg class="h-5 w-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </button>
                <button onclick="openDeleteModal('${t.EventName.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800" title="Delete">
                  <svg class="h-5 w-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function openAddTemplateModal() {
    editingTemplateName = null;
    document.getElementById('template-modal-title').textContent = 'Add New Template';
    document.getElementById('template-submit-btn').textContent = 'Add Template';
    document.getElementById('add-template-form').reset();
    document.getElementById('add-template-modal').classList.remove('hidden');
    document.getElementById('add-template-modal').classList.add('flex');
  }

  function openEditTemplateModal(t) {
    editingTemplateName = t.EventName;
    document.getElementById('template-modal-title').textContent = 'Edit Template';
    document.getElementById('template-submit-btn').textContent = 'Save Changes';
    document.getElementById('original-event-name').value = t.EventName;
    document.getElementById('t-name').value = t.EventName || '';
    document.getElementById('t-type').value = t.EventType || '';
    document.getElementById('t-description').value = t.EventDescription || '';
    document.getElementById('t-recurrence').value = t.EventRecurrencePattern || '';
    document.getElementById('t-capacity').value = t.EventDefaultCapacity || '';
    document.getElementById('add-template-modal').classList.remove('hidden');
    document.getElementById('add-template-modal').classList.add('flex');
  }

  function closeAddTemplateModal() {
    document.getElementById('add-template-modal').classList.add('hidden');
    document.getElementById('add-template-modal').classList.remove('flex');
  }

  function openDeleteModal(name) {
    deleteTemplateName = name;
    document.getElementById('delete-message').textContent = `Are you sure you want to delete "${name}"? This will not delete events using this template, but you won't be able to create new events with it.`;
    document.getElementById('delete-modal').classList.remove('hidden');
    document.getElementById('delete-modal').classList.add('flex');
  }

  function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    document.getElementById('delete-modal').classList.remove('flex');
  }

  async function confirmDelete() {
    try {
      const response = await fetch(`/api/event-templates/${encodeURIComponent(deleteTemplateName)}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Template deleted successfully!');
        closeDeleteModal();
        location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + (error.message || 'Failed to delete. Make sure no events are using this template.'));
      }
    } catch (err) {
      alert('Error deleting template');
    }
  }

  document.getElementById('add-template-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    Object.keys(data).forEach(key => { if (data[key] === '') delete data[key]; });
    
    const isEditing = !!editingTemplateName;
    const method = isEditing ? 'PUT' : 'POST';
    const url = isEditing ? `/api/event-templates/${encodeURIComponent(editingTemplateName)}` : '/api/event-templates';
    
    try {
      const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      if (response.ok) {
        alert(isEditing ? 'Template updated!' : 'Template added!');
        closeAddTemplateModal();
        location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + (error.message || 'Failed to save'));
      }
    } catch (err) { alert('Error saving template'); }
  });

  document.getElementById('add-template-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeAddTemplateModal(); });
  document.getElementById('delete-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeDeleteModal(); });
</script>

