<%- include('../partials/head', { title: 'Ella Rises' }) %>
<%- include('../partials/navbar', { currentPath: '/admin/participants' }) %>
<div class="min-h-screen bg-background pt-28 pb-20">
  <div class="container mx-auto px-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl md:text-6xl font-serif text-foreground">Participants</h1>
      <button onclick="openAddParticipantModal()" class="bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-4 py-2 font-medium flex items-center gap-2">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        Add Participant
      </button>
    </div>
    
    <!-- Search Bar -->
    <div class="mb-6">
      <div class="relative max-w-md">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="search-input" placeholder="Search by name or email..." 
          class="w-full pl-10 pr-4 py-2 border border-border rounded-lg bg-card focus:outline-none focus:ring-2 focus:ring-primary/50"
          oninput="filterParticipants()">
      </div>
      <p class="text-sm text-foreground/50 mt-2" id="search-results-count"></p>
    </div>
    <div id="participants-container" class="bg-card border border-border rounded-xl overflow-hidden">
      <p class="text-foreground/60 p-6">Loading participants...</p>
    </div>
  </div>
</div>

<!-- Add/Edit Participant Modal -->
<div id="add-participant-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="bg-card rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-serif" id="participant-modal-title">Add New Participant</h3>
      <button onclick="closeAddParticipantModal()" class="text-foreground/60 hover:text-foreground">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <form id="add-participant-form" class="space-y-4">
      <input type="hidden" name="ParticipantID" id="participant-id">
      
      <!-- Profile Photo Section -->
      <div class="flex items-center gap-4 pb-4 border-b border-border">
        <div id="photo-preview" class="w-20 h-20 rounded-full bg-muted border-2 border-border flex items-center justify-center overflow-hidden">
          <span class="text-xl text-foreground/40" id="photo-initials">?</span>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-2">Profile Photo</label>
          <input type="file" id="photo-input" accept="image/*" class="text-sm file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground file:font-medium file:cursor-pointer">
          <p class="text-xs text-foreground/50 mt-1">JPG, PNG or GIF (max 5MB)</p>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">First Name *</label><input type="text" name="ParticipantFirstName" id="p-firstname" required class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
        <div><label class="block text-sm font-medium mb-1">Last Name *</label><input type="text" name="ParticipantLastName" id="p-lastname" required class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Email *</label><input type="email" name="ParticipantEmail" id="p-email" required class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone</label>
          <input type="tel" name="ParticipantPhone" id="p-phone" pattern="[0-9]{10}" maxlength="10" placeholder="10 digits" class="w-full border border-border rounded-lg px-3 py-2 bg-background" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          <p class="text-xs text-foreground/50 mt-1">10 digits only</p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" name="ParticipantDOB" id="p-dob" class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
        <div><label class="block text-sm font-medium mb-1">Role</label><select name="ParticipantRole" id="p-role" class="w-full border border-border rounded-lg px-3 py-2 bg-background"><option value="participant">Participant</option><option value="admin">Admin</option></select></div>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium mb-1">City</label><input type="text" name="ParticipantCity" id="p-city" class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
        <div>
          <label class="block text-sm font-medium mb-1">State</label>
          <div class="relative">
            <input type="text" id="p-state-search" placeholder="Search state..." class="w-full border border-border rounded-lg px-3 py-2 bg-background" onfocus="showStateDropdown()" oninput="filterStates(this.value)">
            <input type="hidden" name="ParticipantState" id="p-state">
            <div id="state-dropdown" class="absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-lg max-h-48 overflow-y-auto hidden">
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Zip</label>
          <input type="text" name="ParticipantZip" id="p-zip" pattern="[0-9]{5}" maxlength="5" placeholder="5 digits" class="w-full border border-border rounded-lg px-3 py-2 bg-background" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
      </div>
      <div><label class="block text-sm font-medium mb-1">School or Employer</label><input type="text" name="ParticipantSchoolOrEmployer" id="p-school" class="w-full border border-border rounded-lg px-3 py-2 bg-background"></div>
      <div><label class="block text-sm font-medium mb-1">Field of Interest</label><select name="ParticipantFieldOfInterest" id="p-interest" class="w-full border border-border rounded-lg px-3 py-2 bg-background"><option value="Both">Both (STEAM & Arts)</option><option value="STEAM">STEAM</option><option value="Arts">Arts</option></select></div>
      <div class="flex gap-3 pt-2">
        <button type="button" onclick="closeAddParticipantModal()" class="flex-1 border border-border rounded-lg px-4 py-2 font-medium hover:bg-muted transition-colors">Cancel</button>
        <button type="submit" id="participant-submit-btn" class="flex-1 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-4 py-2 font-medium transition-colors">Add Participant</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
  <div class="bg-card rounded-xl p-6 w-full max-w-md mx-4">
    <h3 class="text-xl font-serif mb-4">Confirm Delete</h3>
    <p class="text-foreground/70 mb-6" id="delete-message">Are you sure you want to delete this participant?</p>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 border border-border rounded-lg px-4 py-2 font-medium hover:bg-muted transition-colors">Cancel</button>
      <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-medium transition-colors">Delete</button>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
<script>
  let participantsData = [];
  let editingParticipantId = null;
  let deleteId = null;

  // US States and Territories
  const states = [
    { name: 'Alabama', abbr: 'AL' }, { name: 'Alaska', abbr: 'AK' }, { name: 'Arizona', abbr: 'AZ' },
    { name: 'Arkansas', abbr: 'AR' }, { name: 'California', abbr: 'CA' }, { name: 'Colorado', abbr: 'CO' },
    { name: 'Connecticut', abbr: 'CT' }, { name: 'Delaware', abbr: 'DE' }, { name: 'Florida', abbr: 'FL' },
    { name: 'Georgia', abbr: 'GA' }, { name: 'Hawaii', abbr: 'HI' }, { name: 'Idaho', abbr: 'ID' },
    { name: 'Illinois', abbr: 'IL' }, { name: 'Indiana', abbr: 'IN' }, { name: 'Iowa', abbr: 'IA' },
    { name: 'Kansas', abbr: 'KS' }, { name: 'Kentucky', abbr: 'KY' }, { name: 'Louisiana', abbr: 'LA' },
    { name: 'Maine', abbr: 'ME' }, { name: 'Maryland', abbr: 'MD' }, { name: 'Massachusetts', abbr: 'MA' },
    { name: 'Michigan', abbr: 'MI' }, { name: 'Minnesota', abbr: 'MN' }, { name: 'Mississippi', abbr: 'MS' },
    { name: 'Missouri', abbr: 'MO' }, { name: 'Montana', abbr: 'MT' }, { name: 'Nebraska', abbr: 'NE' },
    { name: 'Nevada', abbr: 'NV' }, { name: 'New Hampshire', abbr: 'NH' }, { name: 'New Jersey', abbr: 'NJ' },
    { name: 'New Mexico', abbr: 'NM' }, { name: 'New York', abbr: 'NY' }, { name: 'North Carolina', abbr: 'NC' },
    { name: 'North Dakota', abbr: 'ND' }, { name: 'Ohio', abbr: 'OH' }, { name: 'Oklahoma', abbr: 'OK' },
    { name: 'Oregon', abbr: 'OR' }, { name: 'Pennsylvania', abbr: 'PA' }, { name: 'Rhode Island', abbr: 'RI' },
    { name: 'South Carolina', abbr: 'SC' }, { name: 'South Dakota', abbr: 'SD' }, { name: 'Tennessee', abbr: 'TN' },
    { name: 'Texas', abbr: 'TX' }, { name: 'Utah', abbr: 'UT' }, { name: 'Vermont', abbr: 'VT' },
    { name: 'Virginia', abbr: 'VA' }, { name: 'Washington', abbr: 'WA' }, { name: 'West Virginia', abbr: 'WV' },
    { name: 'Wisconsin', abbr: 'WI' }, { name: 'Wyoming', abbr: 'WY' },
    // Territories
    { name: 'American Samoa', abbr: 'AS' }, { name: 'District of Columbia', abbr: 'DC' },
    { name: 'Guam', abbr: 'GU' }, { name: 'Northern Mariana Islands', abbr: 'MP' },
    { name: 'Puerto Rico', abbr: 'PR' }, { name: 'U.S. Virgin Islands', abbr: 'VI' }
  ];

  function showStateDropdown() {
    const dropdown = document.getElementById('state-dropdown');
    dropdown.classList.remove('hidden');
    filterStates('');
  }

  function hideStateDropdown() {
    setTimeout(() => {
      document.getElementById('state-dropdown').classList.add('hidden');
    }, 200);
  }

  function filterStates(search) {
    const dropdown = document.getElementById('state-dropdown');
    const filtered = states.filter(s => 
      s.name.toLowerCase().includes(search.toLowerCase()) || 
      s.abbr.toLowerCase().includes(search.toLowerCase())
    );
    
    dropdown.innerHTML = filtered.map(s => `
      <div class="px-3 py-2 hover:bg-muted cursor-pointer" onclick="selectState('${s.abbr}', '${s.name}')">
        ${s.name} (${s.abbr})
      </div>
    `).join('') || '<div class="px-3 py-2 text-foreground/50">No states found</div>';
  }

  function selectState(abbr, name) {
    document.getElementById('p-state').value = abbr;
    document.getElementById('p-state-search').value = name;
    document.getElementById('state-dropdown').classList.add('hidden');
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#p-state-search') && !e.target.closest('#state-dropdown')) {
      document.getElementById('state-dropdown')?.classList.add('hidden');
    }
  });

  // Load participants
  fetch('/api/participants')
    .then(r => r.json())
    .then(participants => {
      participantsData = participants;
      renderParticipants(participants);
      updateResultsCount(participants.length, participants.length);
    });

  function filterParticipants() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    
    if (!searchTerm) {
      renderParticipants(participantsData);
      updateResultsCount(participantsData.length, participantsData.length);
      return;
    }
    
    const filtered = participantsData.filter(p => {
      const fullName = `${p.ParticipantFirstName} ${p.ParticipantLastName}`.toLowerCase();
      const email = (p.ParticipantEmail || '').toLowerCase();
      return fullName.includes(searchTerm) || email.includes(searchTerm);
    });
    
    renderParticipants(filtered);
    updateResultsCount(filtered.length, participantsData.length);
  }

  function updateResultsCount(shown, total) {
    const countEl = document.getElementById('search-results-count');
    if (shown === total) {
      countEl.textContent = `Showing all ${total} participants`;
    } else {
      countEl.textContent = `Showing ${shown} of ${total} participants`;
    }
  }

  function renderParticipants(participants) {
    const container = document.getElementById('participants-container');
    if (participants.length === 0) {
      container.innerHTML = '<p class="text-foreground/60 p-6">No participants found.</p>';
      return;
    }
    container.innerHTML = `
      <table class="w-full">
        <thead class="bg-muted">
          <tr>
            <th class="text-left p-4 font-medium">Name</th>
            <th class="text-left p-4 font-medium">Email</th>
            <th class="text-left p-4 font-medium">Role</th>
            <th class="text-left p-4 font-medium">City</th>
            <th class="text-right p-4 font-medium">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${participants.map(p => `
            <tr class="border-t border-border hover:bg-muted/50">
              <td class="p-4">
                <a href="/admin/participants/${p.ParticipantID}" class="flex items-center gap-3 text-primary hover:underline font-medium">
                  ${p.ParticipantPhotoPath 
                    ? `<img src="${p.ParticipantPhotoPath}" alt="" class="w-10 h-10 rounded-full object-cover border border-border">`
                    : `<div class="w-10 h-10 rounded-full bg-muted border border-border flex items-center justify-center text-sm text-foreground/40">${(p.ParticipantFirstName || '').charAt(0)}${(p.ParticipantLastName || '').charAt(0)}</div>`
                  }
                  <span>${p.ParticipantFirstName} ${p.ParticipantLastName}</span>
                </a>
              </td>
              <td class="p-4 text-foreground/70">${p.ParticipantEmail}</td>
              <td class="p-4">
                <span class="px-2 py-1 rounded-full text-xs font-medium ${p.ParticipantRole === 'admin' ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'}">
                  ${p.ParticipantRole || 'participant'}
                </span>
              </td>
              <td class="p-4 text-foreground/70">${p.ParticipantCity || '-'}</td>
              <td class="p-4 text-right">
                <button onclick="openEditParticipantModal(${p.ParticipantID})" class="text-blue-600 hover:text-blue-800 mr-3" title="Edit">
                  <svg class="h-5 w-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </button>
                <button onclick="openDeleteModal(${p.ParticipantID}, '${(p.ParticipantFirstName || '').replace(/'/g, "\\'")} ${(p.ParticipantLastName || '').replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800" title="Delete">
                  <svg class="h-5 w-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  let currentParticipantPhoto = null;

  function openAddParticipantModal() {
    editingParticipantId = null;
    currentParticipantPhoto = null;
    document.getElementById('participant-modal-title').textContent = 'Add New Participant';
    document.getElementById('participant-submit-btn').textContent = 'Add Participant';
    document.getElementById('add-participant-form').reset();
    document.getElementById('photo-input').value = '';
    document.getElementById('p-state-search').value = '';
    document.getElementById('p-state').value = '';
    updatePhotoPreview(null, '?');
    document.getElementById('add-participant-modal').classList.remove('hidden');
    document.getElementById('add-participant-modal').classList.add('flex');
  }

async function openEditParticipantModal(participantId) {
    try {
      // Fetch the full participant data from the API
      const response = await fetch(`/api/participants/${participantId}`);
      if (!response.ok) {
        alert('Error loading participant data');
        return;
      }
      const p = await response.json();
      
      editingParticipantId = p.ParticipantID;
      currentParticipantPhoto = p.ParticipantPhotoPath;
      document.getElementById('participant-modal-title').textContent = 'Edit Participant';
      document.getElementById('participant-submit-btn').textContent = 'Save Changes';
      document.getElementById('participant-id').value = p.ParticipantID;
      document.getElementById('p-firstname').value = p.ParticipantFirstName || '';
      document.getElementById('p-lastname').value = p.ParticipantLastName || '';
      document.getElementById('p-email').value = p.ParticipantEmail || '';
      // Strip dashes from phone for editing (stored as XXX-XXX-XXXX)
      document.getElementById('p-phone').value = (p.ParticipantPhone || '').replace(/-/g, '');
      document.getElementById('p-dob').value = p.ParticipantDOB ? (p.ParticipantDOB.split('T')[0] || '') : '';
      document.getElementById('p-role').value = p.ParticipantRole || 'participant';
      document.getElementById('p-city').value = p.ParticipantCity || '';
      document.getElementById('p-state').value = p.ParticipantState || '';
      // Find state name from abbreviation
      const stateObj = states.find(s => s.abbr === p.ParticipantState);
      document.getElementById('p-state-search').value = stateObj ? stateObj.name : (p.ParticipantState || '');
      document.getElementById('p-zip').value = p.ParticipantZip || '';
      document.getElementById('p-school').value = p.ParticipantSchoolOrEmployer || '';
      document.getElementById('p-interest').value = p.ParticipantFieldOfInterest || 'Both';
      document.getElementById('photo-input').value = '';
      
      const initials = (p.ParticipantFirstName || '').charAt(0) + (p.ParticipantLastName || '').charAt(0);
      updatePhotoPreview(p.ParticipantPhotoPath, initials);
      
      document.getElementById('add-participant-modal').classList.remove('hidden');
      document.getElementById('add-participant-modal').classList.add('flex');
    } catch (error) {
      console.error('Error loading participant:', error);
      alert('Error loading participant data');
    }
  }

  function updatePhotoPreview(photoPath, initials) {
    const preview = document.getElementById('photo-preview');
    if (photoPath) {
      preview.innerHTML = `<img src="${photoPath}" alt="Profile" class="w-full h-full object-cover">`;
    } else {
      preview.innerHTML = `<span class="text-xl text-foreground/40">${initials || '?'}</span>`;
    }
  }

  // Photo preview on file select
  document.getElementById('photo-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('photo-preview').innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover">`;
      };
      reader.readAsDataURL(file);
    }
  });

  function closeAddParticipantModal() {
    document.getElementById('add-participant-modal').classList.add('hidden');
    document.getElementById('add-participant-modal').classList.remove('flex');
  }

  function openDeleteModal(id, name) {
    deleteId = id;
    document.getElementById('delete-message').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
    document.getElementById('delete-modal').classList.remove('hidden');
    document.getElementById('delete-modal').classList.add('flex');
  }

  function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    document.getElementById('delete-modal').classList.remove('flex');
  }

  async function confirmDelete() {
    try {
      const response = await fetch(`/api/participants/${deleteId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Participant deleted successfully!');
        closeDeleteModal();
        location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + (error.message || 'Failed to delete'));
      }
    } catch (err) {
      alert('Error deleting participant');
    }
  }

  document.getElementById('add-participant-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    Object.keys(data).forEach(key => { if (data[key] === '') delete data[key]; });
    
    const isEditing = !!editingParticipantId;
    const method = isEditing ? 'PUT' : 'POST';
    const url = isEditing ? `/api/participants/${editingParticipantId}` : '/api/participants';
    
    try {
      // First save participant data
      const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      if (!response.ok) {
        const error = await response.json();
        alert('Error: ' + (error.message || 'Failed to save'));
        return;
      }
      
      const savedParticipant = await response.json();
      const participantId = savedParticipant.ParticipantID || editingParticipantId;
      
      // Then upload photo if one was selected
      const photoInput = document.getElementById('photo-input');
      if (photoInput.files.length > 0) {
        const photoFormData = new FormData();
        photoFormData.append('photo', photoInput.files[0]);
        
        const photoResponse = await fetch(`/api/participants/${participantId}/photo`, {
          method: 'POST',
          body: photoFormData
        });
        
        if (!photoResponse.ok) {
          alert('Participant saved, but photo upload failed.');
        }
      }
      
      alert(isEditing ? 'Participant updated!' : 'Participant added!');
      closeAddParticipantModal();
      location.reload();
    } catch (err) { 
      console.error(err);
      alert('Error saving participant'); 
    }
  });

  document.getElementById('add-participant-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeAddParticipantModal(); });
  document.getElementById('delete-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeDeleteModal(); });
</script>

