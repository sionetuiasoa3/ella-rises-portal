<%- include('partials/head', { title: 'Ella Rises' }) %>
<%- include('partials/navbar', { currentPath: '/events' }) %>
<div class="min-h-screen bg-background">
  <!-- Hero Section -->
  <section class="relative pt-24 pb-16 md:pt-32 md:pb-24 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-muted/60 via-background to-background"></div>
    <div class="absolute top-0 left-0 right-0 h-[400px] bg-gradient-to-br from-ella-cream via-muted/40 to-ella-blush/30"></div>
    <div class="container mx-auto px-6 relative">
      <div class="max-w-3xl mx-auto text-center">
        <h1 class="text-4xl md:text-6xl font-serif text-foreground mb-6 md:mb-8 leading-tight">
          Upcoming <span class="italic text-primary">Events</span>
        </h1>
        <p class="text-lg md:text-xl text-foreground/70 leading-relaxed">
          Join us at our next gathering and be part of something special. Each event is designed to inspire, connect, and empower.
        </p>
      </div>
    </div>
  </section>

  <!-- Events Templates Grid -->
  <section class="py-20 md:py-28">
    <div class="container mx-auto px-6">
      <div id="events-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
        <!-- Event templates will be loaded via JavaScript -->
        <p class="text-foreground/60">Loading events...</p>
      </div>
    </div>
  </section>

  <!-- Registration Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-card border border-border rounded-xl p-8 max-w-md mx-4 shadow-xl">
      <div class="text-center">
        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-serif text-foreground mb-2">Registration Successful!</h3>
        <p class="text-foreground/70 mb-6">You have been successfully registered for this event.</p>
        <button onclick="closeSuccessModal()" class="bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-6 py-2 text-sm font-medium">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Login Required Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-card border border-border rounded-xl p-8 max-w-md mx-4 shadow-xl">
      <div class="text-center">
        <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-foreground/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-serif text-foreground mb-2">Login Required</h3>
        <p class="text-foreground/70 mb-6">You need to be logged in to register for events.</p>
        <div class="flex gap-4 justify-center">
          <button onclick="closeLoginModal()" class="bg-muted hover:bg-muted/80 text-foreground rounded-lg px-6 py-2 text-sm font-medium">
            Cancel
          </button>
          <a href="/portal/auth" class="bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg px-6 py-2 text-sm font-medium inline-block">
            Go to Login
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('partials/notification-modal') %>
<%- include('partials/footer') %>
<%- include('partials/footer-scripts') %>
<script>
  // Fallback event images
  const fallbackImages = [
    '/images/workshop-classroom.jpg',
    '/images/event-workshop-1.jpeg',
    '/images/event-workshop-2.jpeg',
    '/images/event-participants-1.jpeg',
    '/images/event-participants-2.jpeg',
    '/images/event-participants-3.jpeg',
    '/images/summer-summit-event.jpg',
    '/images/event-audience.jpg',
    '/images/art-workshop.jpg',
    '/images/stem-workshop.jpg',
    '/images/community-event.jpg'
  ];

  // Load event templates with dates
  fetch('/api/event-templates/with-dates')
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(templates => {
      console.log('Loaded templates:', templates);
      const container = document.getElementById('events-container');
      if (!container) {
        console.error('Container element not found!');
        return;
      }
      
      if (templates.length === 0) {
        container.innerHTML = '<p class="text-foreground/60">No events available at this time.</p>';
        return;
      }
      
      // Sort templates: ones with events first, then ones without events
      const sortedTemplates = templates.sort((a, b) => {
        const aHasEvents = (a.events || []).length > 0;
        const bHasEvents = (b.events || []).length > 0;
        
        if (aHasEvents && !bHasEvents) return -1; // a comes first
        if (!aHasEvents && bHasEvents) return 1;  // b comes first
        return 0; // keep original order for same category
      });
      
      const now = new Date();
      console.log('Current time for filtering:', now);
      
      container.innerHTML = sortedTemplates.map((template, index) => {
        // Use EventTemplatePhotoPath if available (S3 URL or /uploads/... path), otherwise fallback
        let imagePath = null;
        if (template.EventTemplatePhotoPath) {
          if (template.EventTemplatePhotoPath.startsWith('http')) {
            imagePath = template.EventTemplatePhotoPath;
          } else if (template.EventTemplatePhotoPath.startsWith('/')) {
            imagePath = template.EventTemplatePhotoPath;
          } else {
            // Legacy case: stored key without leading slash
            imagePath = `/uploads/templates/${template.EventTemplatePhotoPath}`;
          }
        } else {
          imagePath = fallbackImages[index % fallbackImages.length];
        }
        
        const imageHtml = imagePath 
          ? `<img src="${imagePath}" alt="${template.EventName}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />`
          : `<div class="w-full h-full bg-muted flex items-center justify-center"><span class="text-foreground/40">Event Image</span></div>`;
        
        // Get future events for this template (already filtered by API, but double-check client-side)
        const allTemplateEvents = template.events || [];
        const now = new Date();
        
        // Filter to only future events (API should already filter, but double-check for timezone safety)
        const futureEvents = allTemplateEvents.filter(event => {
          if (!event || !event.EventDateTimeStart) {
            return false;
          }
          const eventDate = new Date(event.EventDateTimeStart);
          // Check if date is valid and in the future
          if (isNaN(eventDate.getTime())) {
            console.warn('Invalid date for event:', event);
            return false;
          }
          return eventDate > now;
        });
        
        console.log(`Template "${template.EventName}":`, {
          eventsFromAPI: allTemplateEvents.length,
          futureEvents: futureEvents.length
        });
        
        // Build dropdown options - start with default option
        let dateOptionsHtml = '<option value="">Select a date</option>';
        
        if (futureEvents.length > 0) {
          futureEvents.forEach((event, eventIndex) => {
            try {
              if (!event.EventID || !event.EventDateTimeStart) {
                console.warn(`Event ${eventIndex} missing required fields:`, event);
                return;
              }
              
              const startDate = new Date(event.EventDateTimeStart);
              if (isNaN(startDate.getTime())) {
                console.error(`Event ${eventIndex} has invalid date:`, event.EventDateTimeStart);
                return;
              }
              
              const dateStr = startDate.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
              });
              const timeStr = startDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true
              });
              const locationStr = event.EventLocation ? ` - ${event.EventLocation}` : '';
              const label = `${dateStr} at ${timeStr}${locationStr}`;
              
              // Escape HTML special characters
              const safeLabel = label
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
              
              dateOptionsHtml += `<option value="${event.EventID}">${safeLabel}</option>`;
              console.log(`  Added option for EventID ${event.EventID}: ${label}`);
            } catch (err) {
              console.error(`Error formatting event ${eventIndex}:`, err, event);
            }
          });
        } else {
          const eventNameEscaped = template.EventName.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          dateOptionsHtml += `<option value="" disabled>No events planned for ${eventNameEscaped}</option>`;
          console.log(`  No future events for "${template.EventName}"`);
        }
        
        return `
        <div class="bg-card border-0 shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300 rounded-2xl">
          <div class="aspect-video overflow-hidden">
            ${imageHtml}
          </div>
          <div class="p-6">
            <h3 class="text-xl font-serif text-foreground mb-2">${template.EventName}</h3>
            <p class="text-foreground/60 text-sm mb-4">${template.EventDescription || ''}</p>
            ${futureEvents.length === 0 ? `
              <div class="bg-muted/50 border border-border rounded-lg px-4 py-3 text-center">
                <p class="text-sm text-foreground/70">
                  <span class="font-medium">No future events yet</span>
                  <br>
                  <span class="text-xs text-foreground/50">Check back soon for upcoming dates</span>
                </p>
              </div>
            ` : `
            <div class="space-y-3">
              <div class="relative">
                <select 
                  id="date-select-${index}" 
                  name="event-date-${index}"
                  class="w-full bg-background border-2 border-border rounded-lg px-4 py-3 text-sm cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all appearance-none pr-10 text-foreground hover:border-primary/50"
                  data-template-index="${index}"
                >
                  ${dateOptionsHtml}
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <svg class="w-5 h-5 text-foreground/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
              <button 
                onclick="registerForEvent(${index}, '${template.EventName.replace(/'/g, "\\'")}')"
                class="w-full bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg text-center py-3 text-sm font-medium transition-all shadow-sm hover:shadow-md"
              >
                Register
              </button>
            </div>
            `}
          </div>
        </div>
      `;
      }).join('');
      
      console.log('Events container updated with', templates.length, 'templates');
      
      // Verify dropdowns were created correctly
      setTimeout(() => {
        templates.forEach((template, index) => {
          const select = document.getElementById(`date-select-${index}`);
          if (select) {
            console.log(`Dropdown ${index} (${template.EventName}):`, {
              options: select.options.length,
              disabled: select.disabled,
              innerHTML: select.innerHTML.substring(0, 100)
            });
          } else {
            console.error(`Dropdown ${index} not found!`);
          }
        });
      }, 100);
    })
    .catch(err => {
      console.error('Error loading event templates:', err);
      const container = document.getElementById('events-container');
      if (container) {
        container.innerHTML = '<p class="text-foreground/60">Error loading events. Please try again later.</p>';
      }
    });

  // Store templates data for registration
  let templatesData = [];
  fetch('/api/event-templates/with-dates')
    .then(res => res.json())
    .then(data => {
      templatesData = data;
    });

  // Register for event - make it globally accessible
  window.registerForEvent = async function(templateIndex, eventName) {
    const selectElement = document.getElementById(`date-select-${templateIndex}`);
    const eventID = selectElement.value;
    
    if (!eventID) {
      showNotification('Please select a date first.', 'warning', 'Selection Required');
      return;
    }
    
    try {
      // Check if user is logged in by trying to register
      const response = await fetch('/api/registrations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          EventID: parseInt(eventID)
        }),
        credentials: 'include' // Include session cookies
      });
      
      const status = response.status;
      console.log('Registration response status:', status);
      console.log('Registration response ok:', response.ok);
      
      // IMPORTANT: Check status BEFORE parsing JSON
      // Check for 401 (unauthorized) or 403 (forbidden) first - user is not logged in
      if (status === 401 || status === 403) {
        console.log('User not logged in (status:', status, '), showing login modal');
        showLoginModal();
        return;
      }
      
      // Check for other error statuses (400, 404, 500, etc.)
      if (status < 200 || status >= 300) {
        const error = await response.json().catch(() => ({ message: 'Failed to register for event' }));
        console.log('Registration error:', error);
        showNotification(error.message || 'Failed to register for event. Please try again.', 'error', 'Registration Failed');
        return;
      }
      
      // Success! Only show success if we got here (status 200-299)
      const data = await response.json().catch(() => null);
      console.log('Registration successful:', data);
      showSuccessModal();
      // Reset the select
      selectElement.value = '';
    } catch (error) {
      console.error('Error registering for event:', error);
      showNotification('An error occurred. Please try again.', 'error', 'Error');
    }
  }

  // Modal functions
  function showSuccessModal() {
    document.getElementById('success-modal').classList.remove('hidden');
  }

  function closeSuccessModal() {
    document.getElementById('success-modal').classList.add('hidden');
  }

  function showLoginModal() {
    document.getElementById('login-modal').classList.remove('hidden');
  }

  function closeLoginModal() {
    document.getElementById('login-modal').classList.add('hidden');
  }

  // Close modals when clicking outside
  document.getElementById('success-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'success-modal') {
      closeSuccessModal();
    }
  });

  document.getElementById('login-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'login-modal') {
      closeLoginModal();
    }
  });
</script>

