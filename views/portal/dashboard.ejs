<%- include('../partials/head', { title: 'Ella Rises Portal - Dashboard' }) %>
<%- include('../partials/navbar', { currentPath: '/portal/dashboard' }) %>
<div class="min-h-screen pt-28 pb-20 relative overflow-hidden">
  <!-- Enhanced warm gradient background -->
  <div class="absolute inset-0 bg-gradient-to-br from-ella-cream via-ella-blush/40 to-ella-warm-cream"></div>
  
  <!-- Background decorative elements with more color -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <!-- Top right - sage green accent -->
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-ella-sage/15 rounded-full blur-3xl"></div>
    <!-- Bottom left - pink accent -->
    <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-ella-pink/15 rounded-full blur-3xl"></div>
    <!-- Center - peach accent -->
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[700px] h-[700px] bg-ella-peach/10 rounded-full blur-3xl"></div>
    <!-- Top left - subtle purple accent -->
    <div class="absolute top-20 left-10 w-[300px] h-[300px] bg-ella-purple/8 rounded-full blur-3xl"></div>
    <!-- Bottom right - coral accent -->
    <div class="absolute bottom-20 right-10 w-[400px] h-[400px] bg-ella-coral/8 rounded-full blur-3xl"></div>
    
    <!-- Subtle pattern overlay -->
    <div class="absolute inset-0 opacity-[0.02]" style="background-image: radial-gradient(circle at 2px 2px, hsl(150 4% 23%) 1px, transparent 0); background-size: 40px 40px;"></div>
  </div>

  <div class="container mx-auto px-6 relative z-10">
    <!-- Header Section with enhanced styling -->
    <div class="mb-10">
      <div class="inline-flex items-center gap-2 bg-ella-sage/40 border border-ella-sage/30 text-foreground/80 px-5 py-3 rounded-full mb-6 text-base md:text-lg font-medium">
        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </div>
      <h1 class="text-4xl md:text-6xl font-serif text-foreground mb-2">My Portal</h1>
      <p class="text-foreground/60 text-lg">Welcome back! Here's your overview.</p>
    </div>
    
    <% if (typeof updated !== 'undefined' && updated) { %>
      <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
        Profile updated successfully!
      </div>
    <% } %>

    <!-- Top Row: Profile Card and Donations Summary -->
    <div class="grid md:grid-cols-2 gap-6 mb-10">
      <!-- Top Left: Profile Card -->
      <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 relative overflow-hidden">
        <!-- Decorative accent -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-ella-pink/5 rounded-full -mr-16 -mt-16"></div>
        <div class="relative">
          <div class="flex items-center gap-6">
            <div class="flex-shrink-0">
              <% if (participant.ParticipantPhotoPath) { %>
                <img 
                  src="<%= participant.ParticipantPhotoPath %>" 
                  alt="Profile Photo" 
                  class="w-24 h-24 object-cover rounded-full border-4 border-ella-pink/20 shadow-md"
                />
              <% } else { %>
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-ella-pink/20 to-ella-sage/20 border-4 border-ella-pink/20 flex items-center justify-center shadow-md">
                  <span class="text-2xl font-bold text-primary">
                    <%= (participant.ParticipantFirstName || '').charAt(0).toUpperCase() %><%= (participant.ParticipantLastName || '').charAt(0).toUpperCase() %>
                  </span>
                </div>
              <% } %>
            </div>
            <div class="flex-1">
              <h2 class="text-2xl font-serif text-foreground mb-1">
                <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %>
              </h2>
              <p class="text-foreground/60 mb-4 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <%= participant.ParticipantEmail %>
              </p>
              <a 
                href="/portal/profile/edit" 
                class="inline-block bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2.5 rounded-lg font-medium transition-all shadow-md hover:shadow-lg"
              >
                Edit Profile
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Right: Donations Summary -->
      <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 relative overflow-hidden">
        <!-- Decorative accent -->
        <div class="absolute top-0 left-0 w-32 h-32 bg-ella-sage/5 rounded-full -ml-16 -mt-16"></div>
        <div class="relative">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-ella-sage/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-ella-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h2 class="text-xl font-serif text-foreground">My Donations</h2>
          </div>
          <p class="text-foreground/60 mb-2 text-sm">Total contributed</p>
          <p class="text-4xl font-bold text-primary mb-4">
            $<%= (donationsSummary.TotalDonations || 0).toLocaleString() %>
          </p>
          <a 
            href="/donate" 
            class="inline-flex items-center gap-2 text-primary hover:text-primary/80 font-medium transition-colors group"
          >
            Make a Donation
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Achieved Milestones Section -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-lg bg-ella-sage/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-ella-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-serif text-foreground">Achieved Milestones</h2>
      </div>
      <% if (achievedMilestones && achievedMilestones.length > 0) { %>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% achievedMilestones.forEach(milestone => { %>
            <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-6 shadow-md hover:shadow-lg transition-all duration-300 relative overflow-hidden group">
              <div class="absolute top-0 right-0 w-20 h-20 bg-ella-sage/5 rounded-full -mr-10 -mt-10 group-hover:bg-ella-sage/10 transition-colors"></div>
              <div class="relative">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="text-lg font-serif text-foreground flex-1"><%= milestone.MilestoneTitle %></h3>
                  <div class="w-8 h-8 rounded-full bg-ella-sage/20 flex items-center justify-center flex-shrink-0 ml-2">
                    <svg class="w-5 h-5 text-ella-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                </div>
                <p class="text-sm text-foreground/60 flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  <%= new Date(milestone.MilestoneDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </p>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-12 text-center shadow-md">
          <div class="w-16 h-16 rounded-full bg-ella-sage/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-ella-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
          </div>
          <p class="text-foreground/70 text-lg mb-2">No milestones achieved yet</p>
          <p class="text-foreground/50">Keep participating to earn milestones!</p>
        </div>
      <% } %>
    </div>

    <!-- Planned Milestones Section -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-lg bg-ella-pink/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-ella-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-serif text-foreground">Planned Milestones</h2>
      </div>
      <% if (plannedMilestones && plannedMilestones.length > 0) { %>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% plannedMilestones.forEach(milestone => { %>
            <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-6 shadow-md hover:shadow-lg transition-all duration-300 relative overflow-hidden group">
              <div class="absolute top-0 right-0 w-20 h-20 bg-ella-pink/5 rounded-full -mr-10 -mt-10 group-hover:bg-ella-pink/10 transition-colors"></div>
              <div class="relative">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="text-lg font-serif text-foreground flex-1"><%= milestone.MilestoneTitle %></h3>
                  <div class="w-8 h-8 rounded-full bg-ella-pink/20 flex items-center justify-center flex-shrink-0 ml-2">
                    <svg class="w-5 h-5 text-ella-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  </div>
                </div>
                <p class="text-sm text-foreground/60 flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  <%= new Date(milestone.MilestoneDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </p>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-12 text-center shadow-md">
          <div class="w-16 h-16 rounded-full bg-ella-pink/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-ella-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          </div>
          <p class="text-foreground/70 text-lg">No planned milestones at this time.</p>
        </div>
      <% } %>
    </div>

    <!-- Upcoming Events Section -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-lg bg-ella-peach/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-serif text-foreground">Upcoming Events</h2>
      </div>
      <% if (upcomingEvents && upcomingEvents.length > 0) { %>
        <div class="space-y-4">
          <% upcomingEvents.forEach(event => { %>
            <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-6 shadow-md hover:shadow-lg transition-all duration-300">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <%= event.EventName %>
                  </h3>
                  <div class="space-y-2 text-sm text-foreground/70">
                    <p class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <%= event.EventLocation %>
                      </p>
                    <% } %>
                  </div>
                </div>
                <button 
                  onclick="unregisterFromEvent(<%= event.EventID %>)" 
                  class="bg-red-500 hover:bg-red-600 text-white px-6 py-2.5 rounded-lg font-medium transition-all shadow-md hover:shadow-lg whitespace-nowrap"
                >
                  Unregister
                </button>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-12 text-center shadow-md">
          <div class="w-16 h-16 rounded-full bg-ella-peach/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          </div>
          <p class="text-foreground/70 text-lg mb-4">No upcoming events</p>
          <p class="text-foreground/50 mb-6">Check out available events to register!</p>
          <a 
            href="/events"
            class="inline-block bg-primary hover:bg-primary/90 text-primary-foreground px-8 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg"
          >
            Browse Events â†’
          </a>
        </div>
      <% } %>
    </div>

    <!-- Past Events Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Past Events</h2>
      <% if (pastEvents && pastEvents.length > 0) { %>
        <div class="space-y-4">
          <% pastEvents.forEach(event => { %>
            <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-2"><%= event.EventName %></h3>
                  <div class="space-y-1 text-sm text-foreground/60">
                    <p>
                      <strong>Date:</strong> 
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p><strong>Location:</strong> <%= event.EventLocation %></p>
                    <% } %>
                  </div>
                </div>
                <% if (!event.hasSurvey) { %>
                  <a 
                    href="/portal/survey/<%= event.EventID %>" 
                    class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-center"
                  >
                    Take Survey
                  </a>
                <% } else { %>
                  <span class="text-sm text-foreground/60 px-6 py-2">Survey completed</span>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-card border border-border rounded-xl p-6 text-center">
          <p class="text-foreground/60">No past events to display.</p>
        </div>
      <% } %>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>
<%- include('../partials/footer-scripts') %>
<script>
  async function unregisterFromEvent(eventId) {
    if (!confirm('Are you sure you want to unregister from this event?')) {
      return;
    }

    try {
      // Use the unregister endpoint
      const deleteRes = await fetch('/api/registrations/unregister', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ EventID: eventId })
      });

      if (!deleteRes.ok) {
        const error = await deleteRes.json();
        throw new Error(error.message || 'Failed to unregister');
      }

      // Reload the page to show updated events
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
      console.error('Unregister error:', error);
    }
  }
</script>
