<%- include('../partials/head', { title: 'Ella Rises Portal - Dashboard' }) %>
<%- include('../partials/navbar', { currentPath: '/portal/dashboard' }) %>
<div class="min-h-screen bg-background pt-28 pb-20">
  <div class="container mx-auto px-6">
    <h1 class="text-4xl md:text-6xl font-serif text-foreground mb-8">My Portal</h1>
    
    <% if (typeof updated !== 'undefined' && updated) { %>
      <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
        Profile updated successfully!
      </div>
    <% } %>

    <!-- Top Row: Profile Card and Donations Summary -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
      <!-- Top Left: Profile Card -->
      <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
        <div class="flex items-center gap-6">
          <div class="flex-shrink-0">
            <% if (participant.ParticipantPhotoPath) { %>
              <img 
                src="<%= participant.ParticipantPhotoPath %>" 
                alt="Profile Photo" 
                class="w-24 h-24 object-cover rounded-full border-2 border-border"
              />
            <% } else { %>
              <div class="w-24 h-24 rounded-full bg-muted border-2 border-border flex items-center justify-center">
                <span class="text-2xl text-foreground/40">
                  <%= (participant.ParticipantFirstName || '').charAt(0).toUpperCase() %><%= (participant.ParticipantLastName || '').charAt(0).toUpperCase() %>
                </span>
              </div>
            <% } %>
          </div>
          <div class="flex-1">
            <h2 class="text-2xl font-serif text-foreground mb-1">
              <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %>
            </h2>
            <p class="text-foreground/60 mb-4"><%= participant.ParticipantEmail %></p>
            <a 
              href="/portal/profile/edit" 
              class="inline-block bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors"
            >
              Edit Profile
            </a>
          </div>
      </div>
      </div>

      <!-- Top Right: Donations Summary -->
      <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
        <h2 class="text-xl font-serif text-foreground mb-4">My Donations</h2>
        <p class="text-foreground/60 mb-2">Total contributed</p>
        <p class="text-3xl font-semibold text-primary mb-1">
          $<%= (donationsSummary.TotalDonations || 0).toLocaleString() %>
        </p>
        <a 
          href="/donate" 
          class="inline-block text-primary hover:underline mt-4 font-medium"
        >
          Make a Donation →
        </a>
      </div>
    </div>

    <!-- Combined Milestones Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Milestones</h2>
      <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Left: Completed Milestones -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-serif text-foreground">Completed Milestones</h3>
              <button 
                onclick="openAddMilestoneModal(true)"
                class="bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                + Add
              </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% if (achievedMilestones && achievedMilestones.length > 0) { %>
                <% achievedMilestones.forEach(milestone => { %>
                  <div 
                    class="bg-background border border-border rounded-lg p-4 flex items-start justify-between gap-3"
                    data-milestone-id="<%= milestone.Id || milestone.MilestoneID %>"
                    data-milestone-type-id="<%= milestone.MilestoneID %>"
                    data-milestone-date="<%= new Date(milestone.MilestoneDate).toISOString().split('T')[0] %>"
                    data-participant-id="<%= participant.ParticipantID %>"
                    data-is-completed="true"
                  >
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <h4 class="text-base font-serif text-foreground"><%= milestone.MilestoneTitle %></h4>
                        <span class="text-sm text-primary">✓</span>
                      </div>
                      <p class="text-sm text-foreground/60">
                        <% 
                          const milestoneDate = new Date(milestone.MilestoneDate);
                          const futurePlaceholder = new Date('2099-12-31');
                          if (milestoneDate.getTime() !== futurePlaceholder.getTime()) {
                        %>
                          <%= milestoneDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } %>
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button 
                        onclick="openEditMilestoneModalFromElement(this.closest('[data-milestone-id]'))"
                        class="bg-primary hover:bg-primary/90 text-primary-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Edit
                      </button>
                      <button 
                        onclick="deleteMilestone(<%= milestone.Id || milestone.MilestoneID %>)"
                        class="bg-destructive hover:bg-destructive/90 text-destructive-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <p class="text-foreground/60 text-sm text-center py-4">No milestones achieved yet. Keep participating to earn milestones!</p>
              <% } %>
            </div>
          </div>

          <!-- Right: Future Milestone Goals -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-serif text-foreground">Future Milestone Goals</h3>
              <button 
                onclick="openAddMilestoneModal(false)"
                class="bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                + Add
              </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% if (plannedMilestones && plannedMilestones.length > 0) { %>
                <% plannedMilestones.forEach(milestone => { %>
                  <div 
                    class="bg-background border border-border rounded-lg p-4 flex items-start justify-between gap-3"
                    data-milestone-id="<%= milestone.Id || milestone.MilestoneID %>"
                    data-milestone-type-id="<%= milestone.MilestoneID %>"
                    data-milestone-date="<%= new Date(milestone.MilestoneDate).toISOString().split('T')[0] %>"
                    data-participant-id="<%= participant.ParticipantID %>"
                    data-is-completed="false"
                  >
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <h4 class="text-base font-serif text-foreground"><%= milestone.MilestoneTitle %></h4>
                        <span class="text-sm text-foreground/40">○</span>
                      </div>
                      <p class="text-sm text-foreground/60">
                        <% 
                          const milestoneDate = new Date(milestone.MilestoneDate);
                          const futurePlaceholder = new Date('2099-12-31');
                          if (milestoneDate.getTime() !== futurePlaceholder.getTime()) {
                        %>
                          <strong>Goal Date:</strong> <%= milestoneDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } %>
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button 
                        onclick="openEditMilestoneModalFromElement(this.closest('[data-milestone-id]'))"
                        class="bg-primary hover:bg-primary/90 text-primary-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Edit
                      </button>
                      <button 
                        onclick="deleteMilestone(<%= milestone.Id || milestone.MilestoneID %>)"
                        class="bg-destructive hover:bg-destructive/90 text-destructive-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <p class="text-foreground/60 text-sm text-center py-4">No planned milestones at this time.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Events Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Upcoming Events</h2>
      <% if (upcomingEvents && upcomingEvents.length > 0) { %>
        <div class="space-y-4">
          <% upcomingEvents.forEach(event => { %>
            <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-2"><%= event.EventName %></h3>
                  <div class="space-y-1 text-sm text-foreground/60">
                    <p>
                      <strong>Date:</strong> 
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p><strong>Location:</strong> <%= event.EventLocation %></p>
                    <% } %>
                  </div>
                </div>
                <button 
                  onclick="unregisterFromEvent(<%= event.EventID %>)" 
                  class="bg-destructive hover:bg-destructive/90 text-destructive-foreground px-6 py-2 rounded-lg font-medium transition-colors whitespace-nowrap"
                >
                  Unregister
                </button>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-card border border-border rounded-xl p-6 text-center">
          <p class="text-foreground/60 mb-4">No upcoming events. Check out available events to register!</p>
          <a href="/portal/events" class="text-primary hover:underline font-medium">Browse Events →</a>
        </div>
      <% } %>
    </div>

    <!-- Past Events Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Past Events</h2>
      <% if (pastEvents && pastEvents.length > 0) { %>
        <div class="space-y-4">
          <% pastEvents.forEach(event => { %>
            <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-2"><%= event.EventName %></h3>
                  <div class="space-y-1 text-sm text-foreground/60">
                    <p>
                      <strong>Date:</strong> 
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p><strong>Location:</strong> <%= event.EventLocation %></p>
                    <% } %>
                  </div>
                </div>
                <% if (!event.hasSurvey) { %>
                  <a 
                    href="/portal/survey/<%= event.EventID %>" 
                    class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-center"
                  >
                    Take Survey
                  </a>
                <% } else { %>
                  <span class="text-sm text-foreground/60 px-6 py-2">Survey completed</span>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-card border border-border rounded-xl p-6 text-center">
          <p class="text-foreground/60">No past events to display.</p>
        </div>
      <% } %>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>
<%- include('../partials/footer-scripts') %>
<!-- Add/Edit Milestone Modal -->
<div id="milestoneModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-card border border-border rounded-xl p-6 max-w-md w-full mx-4">
    <h3 id="milestoneModalTitle" class="text-2xl font-serif text-foreground mb-4">Add Milestone</h3>
    <form id="milestoneForm" onsubmit="handleMilestoneSubmit(event)">
      <input type="hidden" id="milestoneId" />
      <input type="hidden" id="isCompleted" />
      
      <div class="mb-4">
        <label for="milestoneType" class="block text-sm font-medium text-foreground mb-2">
          Milestone Type
        </label>
        <select 
          id="milestoneType" 
          required
          class="w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground"
        >
          <option value="">Select a milestone...</option>
        </select>
      </div>

      <div id="dateField" class="mb-4">
        <label id="dateFieldLabel" for="milestoneDate" class="block text-sm font-medium text-foreground mb-2">
          Date Achieved
        </label>
        <input 
          type="date" 
          id="milestoneDate" 
          class="w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground"
        />
        <p id="dateFieldHelp" class="text-xs text-foreground/60 mt-1"></p>
      </div>

      <div class="flex gap-3">
        <button 
          type="submit"
          class="flex-1 bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors"
        >
          Save
        </button>
        <button 
          type="button"
          onclick="closeMilestoneModal()"
          class="flex-1 bg-muted hover:bg-muted/80 text-foreground px-6 py-2 rounded-lg font-medium transition-colors"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let milestoneTypes = [];
  let currentMilestoneData = null;

  // Load milestone types on page load
  async function loadMilestoneTypes() {
    try {
      const res = await fetch('/api/milestones/types', {
        credentials: 'same-origin'
      });
      if (res.ok) {
        milestoneTypes = await res.json();
        const select = document.getElementById('milestoneType');
        select.innerHTML = '<option value="">Select a milestone...</option>';
        milestoneTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.MilestoneID;
          option.textContent = type.MilestoneTitle;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading milestone types:', error);
    }
  }

  // Open add milestone modal
  async function openAddMilestoneModal(isCompleted) {
    await loadMilestoneTypes();
    document.getElementById('milestoneModalTitle').textContent = isCompleted 
      ? 'Add Completed Milestone' 
      : 'Add Future Milestone Goal';
    document.getElementById('milestoneId').value = '';
    document.getElementById('isCompleted').value = isCompleted ? 'true' : 'false';
    document.getElementById('milestoneType').value = '';
    document.getElementById('milestoneDate').value = '';
    
    // Always show date field, but change label and requirement based on type
    document.getElementById('dateField').style.display = 'block';
    const dateLabel = document.getElementById('dateFieldLabel');
    const dateHelp = document.getElementById('dateFieldHelp');
    const dateInput = document.getElementById('milestoneDate');
    
    if (isCompleted) {
      dateLabel.textContent = 'Date Achieved';
      dateInput.required = true;
      dateHelp.textContent = '';
    } else {
      dateLabel.textContent = 'Goal Date to Achieve Milestone By';
      dateInput.required = false;
      dateHelp.textContent = 'Optional - leave blank if no specific goal date';
    }
    
    document.getElementById('milestoneModal').classList.remove('hidden');
    currentMilestoneData = null;
  }

  // Open edit milestone modal from element data attributes
  async function openEditMilestoneModalFromElement(element) {
    await loadMilestoneTypes();
    
    const milestoneId = element.dataset.milestoneId;
    const milestoneTypeId = element.dataset.milestoneTypeId;
    const milestoneDate = element.dataset.milestoneDate;
    const participantId = element.dataset.participantId;
    const isCompleted = element.dataset.isCompleted === 'true';
    
    document.getElementById('milestoneModalTitle').textContent = isCompleted 
      ? 'Edit Completed Milestone' 
      : 'Edit Future Milestone Goal';
    document.getElementById('milestoneId').value = milestoneId;
    document.getElementById('isCompleted').value = isCompleted ? 'true' : 'false';
    document.getElementById('milestoneType').value = milestoneTypeId;
    
    // Store original values for composite key lookup if needed
    document.getElementById('milestoneForm').dataset.originalMilestoneId = milestoneTypeId;
    document.getElementById('milestoneForm').dataset.originalMilestoneDate = milestoneDate;
    document.getElementById('milestoneForm').dataset.originalParticipantId = participantId;
    
    // Always show date field, but change label and requirement based on type
    document.getElementById('dateField').style.display = 'block';
    const dateLabel = document.getElementById('dateFieldLabel');
    const dateHelp = document.getElementById('dateFieldHelp');
    const dateInput = document.getElementById('milestoneDate');
    
    if (isCompleted) {
      dateLabel.textContent = 'Date Achieved';
      dateInput.required = true;
      dateHelp.textContent = '';
    } else {
      dateLabel.textContent = 'Goal Date to Achieve Milestone By';
      dateInput.required = false;
      dateHelp.textContent = 'Optional - leave blank if no specific goal date';
    }
    
    const date = new Date(milestoneDate);
    const futurePlaceholder = new Date('2099-12-31');
    if (date.getTime() !== futurePlaceholder.getTime()) {
      dateInput.value = date.toISOString().split('T')[0];
    } else {
      dateInput.value = '';
    }
    
    document.getElementById('milestoneModal').classList.remove('hidden');
  }

  // Close milestone modal
  function closeMilestoneModal() {
    document.getElementById('milestoneModal').classList.add('hidden');
    document.getElementById('milestoneForm').reset();
    currentMilestoneData = null;
  }

  // Handle milestone form submission
  async function handleMilestoneSubmit(event) {
    event.preventDefault();
    
    const milestoneId = document.getElementById('milestoneId').value;
    const isCompleted = document.getElementById('isCompleted').value === 'true';
    const MilestoneID = document.getElementById('milestoneType').value;
    const MilestoneDate = document.getElementById('milestoneDate').value;
    const ParticipantID = <%= participant.ParticipantID %>;
    const form = document.getElementById('milestoneForm');

    try {
      let res;
      if (milestoneId) {
        // Update existing milestone
        // For future milestones, send null/undefined if date is empty
        // For completed milestones, date is required
        const dateValue = isCompleted 
          ? MilestoneDate 
          : (MilestoneDate || null);
        
        const body = {
          MilestoneID,
          MilestoneDate: dateValue,
          isFuture: !isCompleted
        };
        
        // Include original values for composite key lookup if needed
        if (form.dataset.originalMilestoneId) {
          body.originalMilestoneID = form.dataset.originalMilestoneId;
          body.originalMilestoneDate = form.dataset.originalMilestoneDate;
          body.ParticipantID = form.dataset.originalParticipantId;
        }
        
        res = await fetch(`/api/milestones/${milestoneId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
      } else {
        // Create new milestone
        // For future milestones, send null/undefined if date is empty
        // For completed milestones, date is required
        const dateValue = isCompleted 
          ? MilestoneDate 
          : (MilestoneDate || null);
        
        res = await fetch('/api/milestones', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            MilestoneID,
            ParticipantID,
            MilestoneDate: dateValue,
            isFuture: !isCompleted
          })
        });
      }

      if (!res.ok) {
        // Try to parse as JSON, but handle HTML error pages
        let errorMessage = 'Failed to save milestone';
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            const error = await res.json();
            errorMessage = error.message || errorMessage;
          } catch (e) {
            errorMessage = `Server error: ${res.status} ${res.statusText}`;
          }
        } else {
          errorMessage = `Server error: ${res.status} ${res.statusText}`;
        }
        throw new Error(errorMessage);
      }

      closeMilestoneModal();
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
      console.error('Milestone save error:', error);
    }
  }

  // Delete milestone
  async function deleteMilestone(milestoneId) {
    if (!confirm('Are you sure you want to delete this milestone?')) {
      return;
    }

    try {
      // Find the element to get additional data for composite key lookup
      const element = document.querySelector(`[data-milestone-id="${milestoneId}"]`);
      let url = `/api/milestones/${milestoneId}`;
      
      if (element) {
        const params = new URLSearchParams({
          ParticipantID: element.dataset.participantId,
          MilestoneID: element.dataset.milestoneTypeId,
          MilestoneDate: element.dataset.milestoneDate
        });
        url += '?' + params.toString();
      }
      
      const res = await fetch(url, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json'
        }
      });

      if (!res.ok) {
        // Try to parse as JSON, but handle HTML error pages
        let errorMessage = 'Failed to delete milestone';
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            const error = await res.json();
            errorMessage = error.message || errorMessage;
          } catch (e) {
            errorMessage = `Server error: ${res.status} ${res.statusText}`;
          }
        } else {
          errorMessage = `Server error: ${res.status} ${res.statusText}`;
        }
        throw new Error(errorMessage);
      }

      // Parse response
      const result = await res.json();
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
      console.error('Delete milestone error:', error);
    }
  }

  // Close modal when clicking outside
  document.getElementById('milestoneModal').addEventListener('click', (e) => {
    if (e.target.id === 'milestoneModal') {
      closeMilestoneModal();
    }
  });

  async function unregisterFromEvent(eventId) {
    if (!confirm('Are you sure you want to unregister from this event?')) {
      return;
    }

    try {
      // Use the unregister endpoint
      const deleteRes = await fetch('/api/registrations/unregister', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ EventID: eventId })
      });

      if (!deleteRes.ok) {
        const error = await deleteRes.json();
        throw new Error(error.message || 'Failed to unregister');
      }

      // Reload the page to show updated events
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
      console.error('Unregister error:', error);
    }
  }
</script>
