<%- include('../partials/head', { title: 'Ella Rises Portal - Dashboard' }) %>
<%- include('../partials/navbar', { currentPath: '/portal/dashboard' }) %>
<div class="min-h-screen pt-28 pb-20 relative overflow-hidden">
  <!-- Enhanced warm gradient background -->
  <div class="absolute inset-0 bg-gradient-to-br from-ella-cream via-ella-blush/40 to-ella-warm-cream"></div>
  
  <!-- Background decorative elements with more color -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <!-- Top right - sage green accent -->
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-ella-sage/15 rounded-full blur-3xl"></div>
    <!-- Bottom left - pink accent -->
    <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-ella-pink/15 rounded-full blur-3xl"></div>
    <!-- Center - peach accent -->
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[700px] h-[700px] bg-ella-peach/10 rounded-full blur-3xl"></div>
    <!-- Top left - subtle purple accent -->
    <div class="absolute top-20 left-10 w-[300px] h-[300px] bg-ella-purple/8 rounded-full blur-3xl"></div>
    <!-- Bottom right - coral accent -->
    <div class="absolute bottom-20 right-10 w-[400px] h-[400px] bg-ella-coral/8 rounded-full blur-3xl"></div>
    
    <!-- Subtle pattern overlay -->
    <div class="absolute inset-0 opacity-[0.02]" style="background-image: radial-gradient(circle at 2px 2px, hsl(150 4% 23%) 1px, transparent 0); background-size: 40px 40px;"></div>
  </div>

  <div class="container mx-auto px-6 relative z-10">
    <!-- Pending Survey Notification -->
    <% if (typeof pendingSurveys !== 'undefined' && pendingSurveys.length > 0) { %>
      <div id="survey-notification" class="fixed top-24 left-6 z-50 max-w-sm animate-slide-in">
        <div class="bg-gradient-to-r from-primary to-primary/90 text-white rounded-xl shadow-2xl overflow-hidden">
          <div class="p-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="font-semibold text-lg mb-1">Survey Pending!</h4>
                <p class="text-white/90 text-sm mb-3">
                  We'd love to hear about your experience at the <strong><%= pendingSurveys[0].EventName %></strong> event!
                </p>
                <a href="/portal/survey/<%= pendingSurveys[0].EventID %>" 
                   class="inline-flex items-center gap-2 bg-white text-primary px-4 py-2 rounded-lg font-medium text-sm hover:bg-white/90 transition-colors">
                  Take Survey
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
              <button onclick="dismissNotification()" class="text-white/70 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <% if (pendingSurveys.length > 1) { %>
              <p class="text-white/70 text-xs mt-2 pl-13">
                + <%= pendingSurveys.length - 1 %> more survey<%= pendingSurveys.length > 2 ? 's' : '' %> pending
              </p>
            <% } %>
          </div>
        </div>
      </div>
      <style>
        @keyframes slide-in {
          from { transform: translateX(-100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.5s ease-out; }
      </style>
      <script>
        function dismissNotification() {
          const notification = document.getElementById('survey-notification');
          notification.style.transform = 'translateX(-100%)';
          notification.style.opacity = '0';
          notification.style.transition = 'all 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }
        // Auto-dismiss after 15 seconds
        setTimeout(() => {
          const notification = document.getElementById('survey-notification');
          if (notification) dismissNotification();
        }, 15000);
      </script>
    <% } %>

    <!-- Header Section with enhanced styling -->
    <div class="mb-10">
      <div class="inline-flex items-center gap-2 bg-ella-sage/40 border border-ella-sage/30 text-foreground/80 px-5 py-3 rounded-full mb-6 text-base md:text-lg font-medium">
        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </div>
      <h1 class="text-4xl md:text-6xl font-serif text-foreground mb-2">My Portal</h1>
      <p class="text-foreground/60 text-lg">Welcome back! Here's your overview.</p>
    </div>
    
    <% if (typeof updated !== 'undefined' && updated) { %>
      <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
        Profile updated successfully!
      </div>
    <% } %>

    <!-- Top Row: Profile Card and Donations Summary -->
    <div class="grid md:grid-cols-2 gap-6 mb-10">
      <!-- Top Left: Profile Card -->
      <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 relative overflow-hidden">
        <!-- Decorative accent -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-ella-pink/5 rounded-full -mr-16 -mt-16"></div>
        <div class="relative">
          <div class="flex items-center gap-6">
            <div class="flex-shrink-0">
              <% if (participant.ParticipantPhotoPath) { %>
                <img 
                  src="<%= participant.ParticipantPhotoPath %>" 
                  alt="Profile Photo" 
                  class="w-24 h-24 object-cover rounded-full border-4 border-ella-pink/20 shadow-md"
                />
              <% } else { %>
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-ella-pink/20 to-ella-sage/20 border-4 border-ella-pink/20 flex items-center justify-center shadow-md">
                  <span class="text-2xl font-bold text-primary">
                    <%= (participant.ParticipantFirstName || '').charAt(0).toUpperCase() %><%= (participant.ParticipantLastName || '').charAt(0).toUpperCase() %>
                  </span>
                </div>
              <% } %>
            </div>
            <div class="flex-1">
              <h2 class="text-2xl font-serif text-foreground mb-1">
                <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %>
              </h2>
              <p class="text-foreground/60 mb-4 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <%= participant.ParticipantEmail %>
              </p>
              <a 
                href="/portal/profile/edit" 
                class="inline-block bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2.5 rounded-lg font-medium transition-all shadow-md hover:shadow-lg"
              >
                Edit Profile
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Right: Donations Summary -->
      <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 relative overflow-hidden">
        <!-- Decorative accent -->
        <div class="absolute top-0 left-0 w-32 h-32 bg-ella-sage/5 rounded-full -ml-16 -mt-16"></div>
        <div class="relative">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-ella-sage/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-ella-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h2 class="text-xl font-serif text-foreground">My Donations</h2>
          </div>
          <p class="text-foreground/60 mb-2 text-sm">Total contributed</p>
          <p class="text-4xl font-bold text-primary mb-4">
            $<%= (donationsSummary.TotalDonations || 0).toLocaleString() %>
          </p>
          <a 
            href="/donate" 
            class="inline-flex items-center gap-2 text-primary hover:text-primary/80 font-medium transition-colors group"
          >
            Make a Donation
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Combined Milestones Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Milestones</h2>
      <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Left: Completed Milestones -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-serif text-foreground">Completed Milestones</h3>
              <button 
                onclick="openAddMilestoneModal(true)"
                class="bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                + Add
              </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% if (achievedMilestones && achievedMilestones.length > 0) { %>
                <% achievedMilestones.forEach(milestone => { %>
                  <div 
                    class="bg-background border border-border rounded-lg p-4 flex items-start justify-between gap-3"
                    data-milestone-id="<%= milestone.Id || milestone.MilestoneID %>"
                    data-milestone-type-id="<%= milestone.MilestoneID %>"
                    data-milestone-date="<%= new Date(milestone.MilestoneDate).toISOString().split('T')[0] %>"
                    data-participant-id="<%= participant.ParticipantID %>"
                    data-is-completed="true"
                  >
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <h4 class="text-base font-serif text-foreground"><%= milestone.MilestoneTitle %></h4>
                        <span class="text-sm text-primary">✓</span>
                      </div>
                      <p class="text-sm text-foreground/60">
                        <% 
                          const milestoneDate = new Date(milestone.MilestoneDate);
                          const futurePlaceholder = new Date('2099-12-31');
                          if (milestoneDate.getTime() !== futurePlaceholder.getTime()) {
                        %>
                          <%= milestoneDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } %>
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button 
                        onclick="openEditMilestoneModalFromElement(this.closest('[data-milestone-id]'))"
                        class="bg-primary hover:bg-primary/90 text-primary-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Edit
                      </button>
                      <button 
                        onclick="deleteMilestone(<%= milestone.Id || milestone.MilestoneID %>)"
                        class="bg-destructive hover:bg-destructive/90 text-destructive-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <p class="text-foreground/60 text-sm text-center py-4">No milestones achieved yet. Keep participating to earn milestones!</p>
              <% } %>
            </div>
          </div>

          <!-- Right: Future Milestone Goals -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-serif text-foreground">Future Milestone Goals</h3>
              <button 
                onclick="openAddMilestoneModal(false)"
                class="bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                + Add
              </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% if (plannedMilestones && plannedMilestones.length > 0) { %>
                <% plannedMilestones.forEach(milestone => { %>
                  <div 
                    class="bg-background border border-border rounded-lg p-4 flex items-start justify-between gap-3"
                    data-milestone-id="<%= milestone.Id || milestone.MilestoneID %>"
                    data-milestone-type-id="<%= milestone.MilestoneID %>"
                    data-milestone-date="<%= new Date(milestone.MilestoneDate).toISOString().split('T')[0] %>"
                    data-participant-id="<%= participant.ParticipantID %>"
                    data-is-completed="false"
                  >
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <h4 class="text-base font-serif text-foreground"><%= milestone.MilestoneTitle %></h4>
                        <span class="text-sm text-foreground/40">○</span>
                      </div>
                      <p class="text-sm text-foreground/60">
                        <% 
                          const milestoneDate = new Date(milestone.MilestoneDate);
                          const futurePlaceholder = new Date('2099-12-31');
                          if (milestoneDate.getTime() !== futurePlaceholder.getTime()) {
                        %>
                          <strong>Goal Date:</strong> <%= milestoneDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        <% } %>
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button 
                        onclick="openEditMilestoneModalFromElement(this.closest('[data-milestone-id]'))"
                        class="bg-primary hover:bg-primary/90 text-primary-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Edit
                      </button>
                      <button 
                        onclick="deleteMilestone(<%= milestone.Id || milestone.MilestoneID %>)"
                        class="bg-destructive hover:bg-destructive/90 text-destructive-foreground px-3 py-1 rounded text-sm font-medium transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <p class="text-foreground/60 text-sm text-center py-4">No planned milestones at this time.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Events Section -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-lg bg-ella-peach/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-serif text-foreground">Upcoming Events</h2>
      </div>
      <% if (upcomingEvents && upcomingEvents.length > 0) { %>
        <div class="space-y-4">
          <% upcomingEvents.forEach(event => { %>
            <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-6 shadow-md hover:shadow-lg transition-all duration-300">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <%= event.EventName %>
                  </h3>
                  <div class="space-y-2 text-sm text-foreground/70">
                    <p class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <%= event.EventLocation %>
                      </p>
                    <% } %>
                  </div>
                </div>
                <button 
                  onclick="unregisterFromEvent(<%= event.EventID %>)" 
                  class="bg-red-500 hover:bg-red-600 text-white px-6 py-2.5 rounded-lg font-medium transition-all shadow-md hover:shadow-lg whitespace-nowrap"
                >
                  Unregister
                </button>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-white/80 backdrop-blur-sm border border-ella-charcoal/5 rounded-xl p-12 text-center shadow-md">
          <div class="w-16 h-16 rounded-full bg-ella-peach/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-ella-peach" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          </div>
          <p class="text-foreground/70 text-lg mb-4">No upcoming events</p>
          <p class="text-foreground/50 mb-6">Check out available events to register!</p>
          <a 
            href="/events"
            class="inline-block bg-primary hover:bg-primary/90 text-primary-foreground px-8 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg"
          >
            Browse Events →
          </a>
        </div>
      <% } %>
    </div>

    <!-- Past Events Section -->
    <div class="mb-8">
      <h2 class="text-2xl md:text-3xl font-serif text-foreground mb-6">Past Events</h2>
      <% if (pastEvents && pastEvents.length > 0) { %>
        <div class="space-y-4">
          <% pastEvents.forEach(event => { %>
            <div class="bg-card border border-border rounded-xl p-6 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-xl font-serif text-foreground mb-2"><%= event.EventName %></h3>
                  <div class="space-y-1 text-sm text-foreground/60">
                    <p>
                      <strong>Date:</strong> 
                      <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                      }) %>
                    </p>
                    <% if (event.EventLocation) { %>
                      <p><strong>Location:</strong> <%= event.EventLocation %></p>
                    <% } %>
                  </div>
                </div>
                <% if (!event.hasSurvey) { %>
                  <a 
                    href="/portal/survey/<%= event.EventID %>" 
                    class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-center"
                  >
                    Take Survey
                  </a>
                <% } else { %>
                  <span class="text-sm text-foreground/60 px-6 py-2">Survey completed</span>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="bg-card border border-border rounded-xl p-6 text-center">
          <p class="text-foreground/60">No past events to display.</p>
        </div>
      <% } %>
    </div>
  </div>
</div>
<%- include('../partials/notification-modal') %>
<%- include('../partials/footer') %>
<%- include('../partials/footer-scripts') %>

<!-- Add/Edit Milestone Modal -->
<div id="milestoneModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-card border border-border rounded-xl p-6 max-w-md w-full mx-4">
    <h3 id="milestoneModalTitle" class="text-2xl font-serif text-foreground mb-4">Add Milestone</h3>
    <form id="milestoneForm" onsubmit="handleMilestoneSubmit(event)">
      <input type="hidden" id="milestoneId" />
      <input type="hidden" id="isCompleted" />
      
      <div class="mb-4">
        <label for="milestoneType" class="block text-sm font-medium text-foreground mb-2">
          Milestone Type
        </label>
        <select 
          id="milestoneType" 
          required
          class="w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground"
        >
          <option value="">Select a milestone...</option>
        </select>
      </div>

      <div id="dateField" class="mb-4">
        <label id="dateFieldLabel" for="milestoneDate" class="block text-sm font-medium text-foreground mb-2">
          Date Achieved
        </label>
        <input 
          type="date" 
          id="milestoneDate" 
          class="w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground"
        />
        <p id="dateFieldHelp" class="text-xs text-foreground/60 mt-1"></p>
      </div>

      <div class="flex gap-3">
        <button 
          type="submit"
          class="flex-1 bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors"
        >
          Save
        </button>
        <button 
          type="button"
          onclick="closeMilestoneModal()"
          class="flex-1 bg-muted hover:bg-muted/80 text-foreground px-6 py-2 rounded-lg font-medium transition-colors"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let milestoneTypes = [];
  let currentMilestoneData = null;

  // Load milestone types on page load
  async function loadMilestoneTypes() {
    try {
      const res = await fetch('/api/milestones/types', {
        credentials: 'same-origin'
      });
      if (res.ok) {
        milestoneTypes = await res.json();
        const select = document.getElementById('milestoneType');
        select.innerHTML = '<option value="">Select a milestone...</option>';
        milestoneTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.MilestoneID;
          option.textContent = type.MilestoneTitle;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading milestone types:', error);
    }
  }

  // Open add milestone modal
  async function openAddMilestoneModal(isCompleted) {
    await loadMilestoneTypes();
    document.getElementById('milestoneModalTitle').textContent = isCompleted 
      ? 'Add Completed Milestone' 
      : 'Add Future Milestone Goal';
    document.getElementById('milestoneId').value = '';
    document.getElementById('isCompleted').value = isCompleted ? 'true' : 'false';
    document.getElementById('milestoneType').value = '';
    document.getElementById('milestoneDate').value = '';
    
    // Always show date field, but change label and requirement based on type
    document.getElementById('dateField').style.display = 'block';
    const dateLabel = document.getElementById('dateFieldLabel');
    const dateHelp = document.getElementById('dateFieldHelp');
    const dateInput = document.getElementById('milestoneDate');
    
    if (isCompleted) {
      dateLabel.textContent = 'Date Achieved';
      dateInput.required = true;
      dateHelp.textContent = '';
    } else {
      dateLabel.textContent = 'Goal Date to Achieve Milestone By';
      dateInput.required = false;
      dateHelp.textContent = 'Optional - leave blank if no specific goal date';
    }
    
    document.getElementById('milestoneModal').classList.remove('hidden');
    currentMilestoneData = null;
  }

  // Open edit milestone modal from element data attributes
  async function openEditMilestoneModalFromElement(element) {
    await loadMilestoneTypes();
    
    const milestoneId = element.dataset.milestoneId;
    const milestoneTypeId = element.dataset.milestoneTypeId;
    const milestoneDate = element.dataset.milestoneDate;
    const participantId = element.dataset.participantId;
    const isCompleted = element.dataset.isCompleted === 'true';
    
    document.getElementById('milestoneModalTitle').textContent = isCompleted 
      ? 'Edit Completed Milestone' 
      : 'Edit Future Milestone Goal';
    document.getElementById('milestoneId').value = milestoneId;
    document.getElementById('isCompleted').value = isCompleted ? 'true' : 'false';
    document.getElementById('milestoneType').value = milestoneTypeId;
    
    // Store original values for composite key lookup if needed
    document.getElementById('milestoneForm').dataset.originalMilestoneId = milestoneTypeId;
    document.getElementById('milestoneForm').dataset.originalMilestoneDate = milestoneDate;
    document.getElementById('milestoneForm').dataset.originalParticipantId = participantId;
    
    // Always show date field, but change label and requirement based on type
    document.getElementById('dateField').style.display = 'block';
    const dateLabel = document.getElementById('dateFieldLabel');
    const dateHelp = document.getElementById('dateFieldHelp');
    const dateInput = document.getElementById('milestoneDate');
    
    if (isCompleted) {
      dateLabel.textContent = 'Date Achieved';
      dateInput.required = true;
      dateHelp.textContent = '';
    } else {
      dateLabel.textContent = 'Goal Date to Achieve Milestone By';
      dateInput.required = false;
      dateHelp.textContent = 'Optional - leave blank if no specific goal date';
    }
    
    const date = new Date(milestoneDate);
    const futurePlaceholder = new Date('2099-12-31');
    if (date.getTime() !== futurePlaceholder.getTime()) {
      dateInput.value = date.toISOString().split('T')[0];
    } else {
      dateInput.value = '';
    }
    
    document.getElementById('milestoneModal').classList.remove('hidden');
  }

  // Close milestone modal
  function closeMilestoneModal() {
    document.getElementById('milestoneModal').classList.add('hidden');
    document.getElementById('milestoneForm').reset();
    currentMilestoneData = null;
  }

  // Handle milestone form submission
  async function handleMilestoneSubmit(event) {
    event.preventDefault();
    
    const milestoneId = document.getElementById('milestoneId').value;
    const isCompleted = document.getElementById('isCompleted').value === 'true';
    const MilestoneID = document.getElementById('milestoneType').value;
    const MilestoneDate = document.getElementById('milestoneDate').value;
    const ParticipantID = <%= participant.ParticipantID %>;
    const form = document.getElementById('milestoneForm');

    try {
      let res;
      if (milestoneId) {
        // Update existing milestone
        const dateValue = isCompleted 
          ? MilestoneDate 
          : (MilestoneDate || null);
        
        const body = {
          MilestoneID,
          MilestoneDate: dateValue,
          isFuture: !isCompleted
        };
        
        // Include original values for composite key lookup if needed
        if (form.dataset.originalMilestoneId) {
          body.originalMilestoneID = form.dataset.originalMilestoneId;
          body.originalMilestoneDate = form.dataset.originalMilestoneDate;
          body.ParticipantID = form.dataset.originalParticipantId;
        }
        
        res = await fetch(`/api/milestones/${milestoneId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
      } else {
        // Create new milestone
        const dateValue = isCompleted 
          ? MilestoneDate 
          : (MilestoneDate || null);
        
        res = await fetch('/api/milestones', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            MilestoneID,
            ParticipantID,
            MilestoneDate: dateValue,
            isFuture: !isCompleted
          })
        });
      }

      if (!res.ok) {
        let errorMessage = 'Failed to save milestone';
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            const error = await res.json();
            errorMessage = error.message || errorMessage;
          } catch (e) {
            errorMessage = `Server error: ${res.status} ${res.statusText}`;
          }
        } else {
          errorMessage = `Server error: ${res.status} ${res.statusText}`;
        }
        throw new Error(errorMessage);
      }

      closeMilestoneModal();
      window.location.reload();
    } catch (error) {
      showNotification('Error: ' + error.message, 'error', 'Error');
      console.error('Milestone save error:', error);
    }
  }

  // Delete milestone
  async function deleteMilestone(milestoneId) {
    showConfirmation('Are you sure you want to delete this milestone?', async () => {
      await performDeleteMilestone(milestoneId);
    }, 'Delete Milestone');
  }
  
  async function performDeleteMilestone(milestoneId) {

    try {
      const element = document.querySelector(`[data-milestone-id="${milestoneId}"]`);
      let url = `/api/milestones/${milestoneId}`;
      
      if (element) {
        const params = new URLSearchParams({
          ParticipantID: element.dataset.participantId,
          MilestoneID: element.dataset.milestoneTypeId,
          MilestoneDate: element.dataset.milestoneDate
        });
        url += '?' + params.toString();
      }
      
      const res = await fetch(url, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json'
        }
      });

      if (!res.ok) {
        let errorMessage = 'Failed to delete milestone';
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          try {
            const error = await res.json();
            errorMessage = error.message || errorMessage;
          } catch (e) {
            errorMessage = `Server error: ${res.status} ${res.statusText}`;
          }
        } else {
          errorMessage = `Server error: ${res.status} ${res.statusText}`;
        }
        throw new Error(errorMessage);
      }

      window.location.reload();
    } catch (error) {
      showNotification('Error: ' + error.message, 'error', 'Error');
      console.error('Delete milestone error:', error);
    }
  }

  // Close modal when clicking outside
  document.getElementById('milestoneModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'milestoneModal') {
      closeMilestoneModal();
    }
  });

  async function unregisterFromEvent(eventId) {
    showConfirmation('Are you sure you want to unregister from this event?', async () => {
      await performUnregisterFromEvent(eventId);
    }, 'Unregister from Event');
  }
  
  async function performUnregisterFromEvent(eventId) {

    try {
      // Use the unregister endpoint
      const deleteRes = await fetch('/api/registrations/unregister', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ EventID: eventId })
      });

      if (!deleteRes.ok) {
        const error = await deleteRes.json();
        throw new Error(error.message || 'Failed to unregister');
      }

      // Reload the page to show updated events
      window.location.reload();
    } catch (error) {
      showNotification('Error: ' + error.message, 'error', 'Error');
      console.error('Unregister error:', error);
    }
  }
</script>
